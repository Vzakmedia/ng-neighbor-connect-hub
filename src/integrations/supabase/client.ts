// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';
import { getSafeStorage } from '@/utils/iosCompatibility';

const SUPABASE_URL = "https://cowiviqhrnmhttugozbz.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNvd2l2aXFocm5taHR0dWdvemJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwNTQ0NDQsImV4cCI6MjA2ODYzMDQ0NH0.BJ6OstIOar6CqEv__WzF9qZYaW12uQ-FfXYaVdxgJM4";

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

// Get safe storage for iOS compatibility (handles private browsing)
const storage = getSafeStorage();

// Enhanced error handling for iOS Safari security restrictions
const createSupabaseClient = () => {
  try {
    return createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
      auth: {
        storage,
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true, // Enable for iOS email verification deep links
        storageKey: 'neighborlink-auth',
        flowType: 'pkce', // More secure auth flow for iOS
      },
      realtime: {
        // iOS WebSocket compatibility
        params: {
          eventsPerSecond: 2, // Reduce events for iOS
        },
        heartbeatIntervalMs: 30000, // Longer heartbeat for iOS
        reconnectAfterMs: (tries: number) => Math.min(tries * 1000, 30000), // Gradual backoff
        // transport: 'websocket', // Force WebSocket transport - removed due to type issues
      },
      global: {
        headers: {
          'X-Client-Info': 'neighborlink-ios-compat',
          'Cache-Control': 'no-cache',
        },
        fetch: (url, options = {}) => {
          // Enhanced fetch with iOS security error handling
          const enhancedOptions = {
            ...options,
            credentials: 'same-origin' as RequestCredentials,
            mode: 'cors' as RequestMode,
          };
          
          return fetch(url, enhancedOptions).catch((error) => {
            if (error.name === 'SecurityError' || error.message?.includes('insecure')) {
              console.warn('iOS Safari security restriction detected, retrying with fallback');
              // Retry with minimal options
          return fetch(url, {
            ...options,
            credentials: 'omit' as RequestCredentials,
            mode: 'cors' as RequestMode,
          });
            }
            throw error;
          });
        },
      },
    });
  } catch (error) {
    console.error('Failed to create Supabase client:', error);
    throw new Error('Unable to initialize secure connection. Please try refreshing the page.');
  }
};

export const supabase = createSupabaseClient();